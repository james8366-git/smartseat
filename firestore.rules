rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* --------------------------------------------
     * USERS
     * -------------------------------------------- */
    match /users/{userId} {

      /* ---- ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ ---- */
      function validUser() {
        return request.resource.data.name is string
          && request.resource.data.name.size() >= 2
          && request.resource.data.name.size() <= 40

          && request.resource.data.nickname is string
          && request.resource.data.nickname.size() >= 1
          && request.resource.data.nickname.size() <= 8

          && request.resource.data.department is string
          && request.resource.data.goals is int
          && request.resource.data.isadmin is bool
      }

      /* ---- seatIdë§Œ ìˆ˜ì •í•˜ëŠ” update ---- */
      function isSeatIdOnlyUpdate() {
        let diff = request.resource.data.diff(resource.data);

        return (
          diff.changedKeys().hasOnly(["seatId"])
          && diff.addedKeys().hasOnly([])
          && diff.removedKeys().hasOnly([])
        )
        ||
        (
          diff.changedKeys().hasOnly([])
          && diff.addedKeys().hasOnly(["seatId"])
          && diff.removedKeys().hasOnly([])
        );
      }

      /* ---- READ RULES ---- */

      // ðŸ”µ 1) ì¤‘ë³µí™•ì¸ìš©: users ì»¬ë ‰ì…˜ "list" í—ˆìš©
      //     â†’ .where("nickname", "==", "...") í—ˆìš©
      allow list: if true;

      // ðŸ”µ 2) ë¬¸ì„œ ë‚´ìš©ì„ ì½ëŠ” ê²ƒì€ ë³¸ì¸ë§Œ
      allow get: if request.auth != null
        && request.auth.uid == userId;


      /* ---- WRITE RULES ---- */

      // ðŸ”¥ íšŒì›ê°€ìž…(create)
      allow create: if request.auth != null
        && request.auth.uid == userId

      // ðŸ”¥ update: seatIdë§Œ ìˆ˜ì • OR ìœ íš¨í•œ ì „ì²´ ì—…ë°ì´íŠ¸
      allow update: if request.auth != null
        && request.auth.uid == userId
        && (validUser() || isSeatIdOnlyUpdate());

      // ðŸ”¥ delete
      allow delete: if request.auth != null
        && request.auth.uid == userId
        && validUser();
    }


    /* --------------------------------------------
     * STUDYLOGS
     * -------------------------------------------- */
    match /studylogs/{logId} {

      allow read: if request.auth != null
        && (request.auth.uid == resource.data.uid
            || request.auth.token.admin == true);

      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.uid;

      allow update, delete: if false;
    }


    /* --------------------------------------------
     * STATS
     * -------------------------------------------- */
    match /stats/{userId} {

      allow read: if request.auth != null
        && (request.auth.uid == userId
            || request.auth.token.admin == true);

      allow write: if request.auth.token.admin == true;
    }


    /* --------------------------------------------
     * GROUPS
     * -------------------------------------------- */
    match /groups/{groupId} {

      allow read: if request.auth != null;

      allow write: if request.auth != null
        && request.auth.uid in request.resource.data.members;
    }


    /* --------------------------------------------
     * NOTIFICATIONS
     * -------------------------------------------- */
    match /notifications/{notifId} {

      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      allow create: if request.auth.token.admin == true;

      allow update, delete: if false;
    }


    /* --------------------------------------------
     * SEATS
     * -------------------------------------------- */
    match /seats/{seatId} {

      allow read: if request.auth != null;

      allow update: if request.auth != null;

      allow create, delete: if false;
    }
  }
}
